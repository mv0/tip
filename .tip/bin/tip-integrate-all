#!/bin/sh

. $(dirname "$0")/tip-lib

tip-backup || { echo "backup failed"; exit -1; }

AB=$(get_auto_branches_no_latest)

for B in $AB
do
    tip-integrate $B || { echo "Integration of "$B" failed"; exit -1; }
done

tip-integrate auto-latest || { echo "Integration of auto-latest failed"; exit -1; }

git-checkout auto-latest
git branch -f master

#
# Ok, we have a new auto-integration result, now carry over
# our local fixups which are in out-of-tree
#
git checkout master

git merge out-of-tree || {
	echo Merging $B failed
	echo merge conflict - run tip-mergetool
	echo
	echo running subshell - type "exit" when resolved
	$SHELL || abort_merge

	NCOM=`git-ls-files -u`
	if [ ! -z "$NCOM" ]
	then
	    echo "Merge was not committed! Fixing it up"
	    git-add $(git-ls-files -u | cut -f2 | sort | uniq)
	    git-commit -s || abort_merge;
	fi
}

D=`get_date_for_tag`

# save the new master head:
git-tag -m "auto-latest update: $D" tip-history-$D master ||
					   { echo error6; exit -1; }

#
# Do some backups ...
#
date				>> ~/tip-master.log
cat .git/refs/heads/master	>> ~/tip-master.log
echo				>> ~/tip-master.log

echo "integration done - new tag: tip-history-$D"

